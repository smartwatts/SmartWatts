name: Deploy Staging (main branch)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  AZURE_RESOURCE_GROUP: sw-staging-rg
  ENVIRONMENT: staging
  LOCATION: westeurope

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS_STAGING }}

    - name: Create Resource Group
      run: |
        az group create \
          --name ${{ env.AZURE_RESOURCE_GROUP }} \
          --location ${{ env.LOCATION }} \
          --output none

    - name: Register Required Resource Providers
      run: |
        az provider register --namespace microsoft.operationalinsights --wait
        az provider register --namespace microsoft.devices --wait
        az provider register --namespace microsoft.storage --wait
        az provider register --namespace microsoft.web --wait
        az provider register --namespace microsoft.keyvault --wait
        az provider register --namespace microsoft.network --wait

    - name: Deploy Infrastructure (Bicep)
      run: |
        az deployment group create \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --template-file infrastructure/bicep/main.bicep \
          --parameters @infrastructure/bicep/params.staging.json \
          --parameters vmAdminPassword="${{ secrets.VM_ADMIN_PASSWORD_STAGING }}"

    - name: Get VM Public IP
      id: get-vm-ip
      run: |
        VM_IP=$(az vm show -d \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name sw-staging-vm \
          --query publicIps -o tsv)
        echo "vm_ip=$VM_IP" >> $GITHUB_OUTPUT

    - name: Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        # Write SSH private key - decode from base64 if needed
        SSH_KEY="${{ secrets.VM_SSH_PRIVATE_KEY_STAGING }}"
        # Check if key starts with BEGIN marker (plain text PEM format)
        if echo "$SSH_KEY" | head -c 20 | grep -q "BEGIN"; then
          # Key is already in plain text PEM format
          echo "$SSH_KEY" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' > ~/.ssh/id_rsa
        else
          # Key appears to be base64 encoded - decode it
          echo "$SSH_KEY" | base64 -d > ~/.ssh/id_rsa
        fi
        chmod 600 ~/.ssh/id_rsa
        # Verify key format - check if it starts with BEGIN and ends with END
        # Check for both RSA and OPENSSH formats
        if ! grep -qE "BEGIN.*PRIVATE KEY" ~/.ssh/id_rsa || ! grep -qE "END.*PRIVATE KEY" ~/.ssh/id_rsa; then
          echo "Error: SSH key format is invalid - missing BEGIN/END markers"
          echo "Key file size: $(wc -c < ~/.ssh/id_rsa) bytes"
          echo "Number of lines: $(wc -l < ~/.ssh/id_rsa)"
          echo "First line (first 50 chars):"
          head -n 1 ~/.ssh/id_rsa | head -c 50
          echo ""
          echo "Last line (last 50 chars):"
          tail -n 1 ~/.ssh/id_rsa | tail -c 50
          echo ""
          echo "Checking for BEGIN marker:"
          grep -i "BEGIN" ~/.ssh/id_rsa | head -n 1 || echo "No BEGIN marker found"
          echo "Checking for END marker:"
          grep -i "END" ~/.ssh/id_rsa | tail -n 1 || echo "No END marker found"
          exit 1
        fi
        # Verify key can be read by ssh-keygen
        if ! ssh-keygen -l -f ~/.ssh/id_rsa > /dev/null 2>&1; then
          echo "Error: SSH key cannot be read by ssh-keygen"
          echo "Key file size: $(wc -c < ~/.ssh/id_rsa) bytes"
          echo "Key type detected:"
          head -n 1 ~/.ssh/id_rsa
          exit 1
        fi
        ssh-keyscan -H ${{ steps.get-vm-ip.outputs.vm_ip }} >> ~/.ssh/known_hosts
        # Extract public key
        ssh-keygen -y -f ~/.ssh/id_rsa > ~/.ssh/id_rsa.pub
        # Add public key to VM using Azure CLI
        az vm user update \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name sw-staging-vm \
          --username azureuser \
          --ssh-key-value "$(cat ~/.ssh/id_rsa.pub)" || echo "Note: Could not add public key via Azure CLI (may already exist)"

    - name: Deploy Application to VM
      run: |
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa azureuser@${{ steps.get-vm-ip.outputs.vm_ip }} << 'EOF'
          # Install Docker if not present
          if ! command -v docker &> /dev/null; then
            curl -fsSL https://get.docker.com -o get-docker.sh
            sudo sh get-docker.sh
            sudo usermod -aG docker $USER
          fi
          
          # Install Docker Compose if not present
          if ! command -v docker-compose &> /dev/null; then
            sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
          fi
          
          # Clone or update repository
          if [ -d "smartwatts" ]; then
            cd smartwatts
            git pull
          else
            git clone https://github.com/${{ github.repository }}.git smartwatts
            cd smartwatts
          fi
          
          # Deploy with Docker Compose
          cd azure-deployment
          docker-compose -f docker-compose.azure.yml up -d --build
        EOF

    - name: Deploy Frontend to Static Web Apps
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_STAGING }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: "upload"
        app_location: "frontend"
        output_location: ".next"
        skip_app_build: false
        skip_api_build: true

    - name: Get Deployment Outputs
      run: |
        echo "VM Public IP: ${{ steps.get-vm-ip.outputs.vm_ip }}"
        echo "Static Web App URL: $(az staticwebapp show \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name sw-staging-dashboard \
          --query defaultHostname -o tsv)"

    - name: Health Check
      run: |
        sleep 60  # Wait for services to start
        VM_IP="${{ steps.get-vm-ip.outputs.vm_ip }}"
        curl -f http://$VM_IP:8080/actuator/health || exit 1

