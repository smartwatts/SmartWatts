# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions

name: Build and deploy Node.js app to Azure Web App - SmartWatts

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read #This is required for actions/checkout

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js version
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'

      - name: npm install, build, and test
        working-directory: ./frontend
        run: |
          npm install
          npm run build --if-present
          # Tests temporarily disabled
          # npm run test --if-present

      - name: Upload artifact for deployment job
        uses: actions/upload-artifact@v4
        with:
          name: node-app
          path: ./frontend

  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      id-token: write #This is required for requesting the JWT
      contents: read #This is required for actions/checkout

    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: node-app
      
      - name: Prepare deployment package for standalone mode
        run: |
          echo "üì¶ Preparing Next.js standalone deployment package..."
          
          # Check if standalone build exists
          if [ ! -d ".next/standalone" ]; then
            echo "‚ùå Error: .next/standalone directory not found"
            echo "The build may have failed or standalone mode is not enabled"
            exit 1
          fi
          
          # Create deployment directory
          mkdir -p deploy-package
          
          # Copy standalone output
          echo "Copying standalone files..."
          cp -r .next/standalone/* deploy-package/
          
          # Copy static files
          if [ -d ".next/static" ]; then
            echo "Copying static files..."
            mkdir -p deploy-package/.next/static
            cp -r .next/static/* deploy-package/.next/static/
          fi
          
          # Copy public directory
          if [ -d "public" ]; then
            echo "Copying public files..."
            cp -r public deploy-package/
          fi
          
          # Verify server.js exists
          if [ ! -f "deploy-package/server.js" ]; then
            echo "‚ùå Error: server.js not found in standalone output"
            exit 1
          fi
          
          echo "‚úÖ Deployment package prepared"
          echo "Contents:"
          ls -la deploy-package/ | head -20
          echo ""
          echo "Verifying server.js:"
          head -5 deploy-package/server.js || echo "Could not read server.js"
      
      - name: Configure Azure Web App for standalone mode
        run: |
          APP_NAME="SmartWatts"
          RESOURCE_GROUP=$(az webapp show --name $APP_NAME --query resourceGroup -o tsv 2>/dev/null || echo "")
          
          if [ -z "$RESOURCE_GROUP" ]; then
            RESOURCE_GROUP=$(az webapp list --query "[?name=='$APP_NAME'].resourceGroup" -o tsv 2>/dev/null | head -1 || echo "")
          fi
          
          if [ -n "$RESOURCE_GROUP" ]; then
            echo "‚öôÔ∏è  Configuring Azure Web App for Next.js standalone mode..."
            
            # Set startup command to use node server.js
            az webapp config set \
              --resource-group $RESOURCE_GROUP \
              --name $APP_NAME \
              --startup-file "node server.js" \
              --output none
            
            # Disable build during deployment
            az webapp config appsettings set \
              --resource-group $RESOURCE_GROUP \
              --name $APP_NAME \
              --settings \
                SCM_DO_BUILD_DURING_DEPLOYMENT=false \
                ENABLE_ORYX_BUILD=false \
                POST_BUILD_COMMAND="" \
                PRE_BUILD_COMMAND="" \
              --output none
            
            echo "‚úÖ Azure Web App configured for standalone mode"
          else
            echo "‚ö†Ô∏è  Could not determine resource group, skipping configuration"
          fi
      
      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_577CA716950C4C849FCD8534DB68F666 }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_E0A871202B5249189A79EA035FBEB0E8 }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_07BBF5665D464E728201D26286D736CD }}

      - name: Check for active deployments
        id: check-deployment
        continue-on-error: true
        run: |
          APP_NAME="SmartWatts"
          
          # Try multiple methods to find the resource group
          RESOURCE_GROUP=$(az webapp show --name $APP_NAME --query resourceGroup -o tsv 2>/dev/null || echo "")
          
          # If that fails, try searching for the web app
          if [ -z "$RESOURCE_GROUP" ]; then
            echo "‚ö†Ô∏è  Could not get resource group from webapp show, trying alternative method..."
            RESOURCE_GROUP=$(az webapp list --query "[?name=='$APP_NAME'].resourceGroup" -o tsv 2>/dev/null | head -1 || echo "")
          fi
          
          if [ -z "$RESOURCE_GROUP" ]; then
            echo "‚ö†Ô∏è  Could not determine resource group for web app '$APP_NAME'"
            echo "Skipping active deployment check (web app may not exist yet)"
            echo "active=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "‚úÖ Found resource group: $RESOURCE_GROUP"
          
          echo "Checking for active deployments in resource group: $RESOURCE_GROUP"
          
          # Check for active deployments
          ACTIVE_DEPLOYMENTS=$(az webapp deployment list \
            --resource-group $RESOURCE_GROUP \
            --name $APP_NAME \
            --query "[?status=='Running' || status=='InProgress'].id" \
            -o tsv 2>/dev/null || echo "")
          
          if [ -n "$ACTIVE_DEPLOYMENTS" ]; then
            echo "‚ö†Ô∏è  Active deployment(s) found, waiting for completion..."
            echo "active=true" >> $GITHUB_OUTPUT
            
            # Wait for active deployments to complete (max 10 minutes)
            MAX_WAIT=600
            ELAPSED=0
            while [ $ELAPSED -lt $MAX_WAIT ]; do
              ACTIVE=$(az webapp deployment list \
                --resource-group $RESOURCE_GROUP \
                --name $APP_NAME \
                --query "[?status=='Running' || status=='InProgress'].id" \
                -o tsv 2>/dev/null || echo "")
              
              if [ -z "$ACTIVE" ]; then
                echo "‚úÖ All active deployments completed"
                echo "active=false" >> $GITHUB_OUTPUT
                break
              fi
              
              echo "‚è≥ Waiting for deployment to complete... (${ELAPSED}s elapsed)"
              sleep 10
              ELAPSED=$((ELAPSED + 10))
            done
            
            if [ $ELAPSED -ge $MAX_WAIT ]; then
              echo "‚ö†Ô∏è  Warning: Timeout waiting for active deployments, proceeding anyway"
            fi
          else
            echo "‚úÖ No active deployments found"
            echo "active=false" >> $GITHUB_OUTPUT
          fi

      - name: 'Deploy to Azure Web App'
        id: deploy-to-webapp
        timeout-minutes: 15
        continue-on-error: true
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'SmartWatts'
          slot-name: 'Production'
          package: ./deploy-package
          
      - name: Handle deployment result
        if: steps.deploy-to-webapp.outcome == 'failure'
        continue-on-error: true
        run: |
          echo "‚ö†Ô∏è  Deployment step failed, checking for conflict errors..."
          
          APP_NAME="SmartWatts"
          
          # Try multiple methods to find the resource group
          RESOURCE_GROUP=$(az webapp show --name $APP_NAME --query resourceGroup -o tsv 2>/dev/null || echo "")
          
          # If that fails, try searching for the web app
          if [ -z "$RESOURCE_GROUP" ]; then
            echo "‚ö†Ô∏è  Could not get resource group from webapp show, trying alternative method..."
            RESOURCE_GROUP=$(az webapp list --query "[?name=='$APP_NAME'].resourceGroup" -o tsv 2>/dev/null | head -1 || echo "")
          fi
          
          # If we still can't find it, try to list all web apps and search
          if [ -z "$RESOURCE_GROUP" ]; then
            echo "‚ö†Ô∏è  Could not determine resource group for web app '$APP_NAME'"
            echo "This might mean:"
            echo "  - The web app doesn't exist yet"
            echo "  - There's an authentication issue"
            echo "  - The web app name is incorrect"
            echo ""
            echo "Checking if this is a conflict error (409) from the deployment logs..."
            
            # Since we can't check active deployments without resource group,
            # we'll assume it's a conflict if the deployment action reported a 409
            # The azure/webapps-deploy action typically outputs "Conflict (CODE: 409)"
            echo "‚ö†Ô∏è  Unable to verify conflict status without resource group"
            echo "If the error above shows 'Conflict (CODE: 409)', this is a transient conflict."
            echo "The deployment will be retried on the next workflow run."
            echo ""
            echo "To resolve:"
            echo "  1. Check if the web app exists: az webapp list --query \"[?name=='$APP_NAME']\""
            echo "  2. Check the Azure Portal for stuck deployments"
            echo "  3. Verify the web app name is correct"
            
            # Don't fail the workflow - let the user check the logs
            exit 0
          fi
          
          echo "‚úÖ Found resource group: $RESOURCE_GROUP"
          
          # Check if there are active deployments (which indicates a conflict)
          ACTIVE_DEPLOYMENTS=$(az webapp deployment list \
            --resource-group $RESOURCE_GROUP \
            --name $APP_NAME \
            --query "[?status=='Running' || status=='InProgress'].id" \
            -o tsv 2>/dev/null || echo "")
          
          if [ -n "$ACTIVE_DEPLOYMENTS" ]; then
            echo "‚ö†Ô∏è  Deployment conflict detected (409) - another deployment is in progress"
            echo "This is a transient conflict that will resolve automatically."
            echo "The deployment will be retried on the next workflow run."
            echo "If this persists, check the Azure Portal for stuck deployments."
            echo "Active deployment IDs: $ACTIVE_DEPLOYMENTS"
            exit 0  # Don't fail the workflow for conflicts
          fi
          
          # No active deployments but deployment failed - this is a real error
          echo "‚ùå Deployment failed and no active deployments found"
          echo "This appears to be a non-conflict error."
          echo "Please check the deployment logs above for details."
          echo "Common causes:"
          echo "  - Invalid package structure"
          echo "  - Missing dependencies"
          echo "  - Build errors"
          echo "  - Permission issues"
          echo "  - Web app configuration issues"
          exit 1
          