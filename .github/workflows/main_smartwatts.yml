# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions

name: Build and deploy Node.js app to Azure Web App - SmartWatts

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read #This is required for actions/checkout

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js version
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'

      - name: npm install, build, and test
        working-directory: ./frontend
        run: |
          npm install
          npm run build --if-present
          # Tests temporarily disabled
          # npm run test --if-present
          
          # Verify standalone build was created
          if [ ! -d ".next/standalone" ]; then
            echo "âŒ Error: .next/standalone directory not found after build"
            echo "This means standalone mode is not working correctly"
            echo "Checking next.config.js..."
            cat next.config.js | grep -i "output" || echo "No output config found"
            echo "Build output:"
            ls -la .next/ 2>/dev/null || echo ".next directory not found"
            exit 1
          fi
          
          echo "âœ… Standalone build verified"
          echo "Standalone directory contents:"
          ls -la .next/standalone/ | head -10

      - name: Upload artifact for deployment job
        uses: actions/upload-artifact@v4
        with:
          name: node-app
          path: |
            ./frontend/.next/standalone
            ./frontend/.next/static
            ./frontend/public
          retention-days: 1

  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      id-token: write #This is required for requesting the JWT
      contents: read #This is required for actions/checkout

    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: node-app
          path: ./artifact
      
      - name: Prepare deployment package for standalone mode
        run: |
          echo "ðŸ“¦ Preparing Next.js standalone deployment package..."
          
          # Check artifact structure (GitHub Actions preserves path structure)
          echo "Checking artifact structure..."
          find artifact -type d -maxdepth 3 2>/dev/null | head -20 || echo "Artifact directory not found"
          
          # Find standalone directory (could be at different paths depending on how artifact was uploaded)
          STANDALONE_DIR=$(find artifact -type d -name "standalone" 2>/dev/null | head -1 || echo "")
          
          if [ -z "$STANDALONE_DIR" ]; then
            echo "âŒ Error: .next/standalone directory not found in artifact"
            echo "Artifact contents:"
            ls -la artifact/ 2>/dev/null || echo "Artifact directory not found"
            find artifact -type d 2>/dev/null | head -20 || echo "No directories found"
            exit 1
          fi
          
          echo "âœ… Found standalone directory at: $STANDALONE_DIR"
          
          # Find static directory
          STATIC_DIR=$(find artifact -type d -path "*/static" 2>/dev/null | head -1 || echo "")
          if [ -z "$STATIC_DIR" ]; then
            echo "âš ï¸  Warning: .next/static directory not found"
          else
            echo "âœ… Found static directory at: $STATIC_DIR"
          fi
          
          # Find public directory
          PUBLIC_DIR=$(find artifact -type d -name "public" 2>/dev/null | head -1 || echo "")
          if [ -z "$PUBLIC_DIR" ]; then
            echo "âš ï¸  Warning: public directory not found"
          else
            echo "âœ… Found public directory at: $PUBLIC_DIR"
          fi
          
          # Create deployment directory
          mkdir -p deploy-package
          
          # Copy standalone output
          echo "Copying standalone files from $STANDALONE_DIR..."
          cp -r "$STANDALONE_DIR"/* deploy-package/
          
          # Copy static files
          if [ -n "$STATIC_DIR" ]; then
            echo "Copying static files from $STATIC_DIR..."
            mkdir -p deploy-package/.next/static
            cp -r "$STATIC_DIR"/* deploy-package/.next/static/
          fi
          
          # Copy public directory
          if [ -n "$PUBLIC_DIR" ]; then
            echo "Copying public files from $PUBLIC_DIR..."
            cp -r "$PUBLIC_DIR" deploy-package/
          fi
          
          # Check if package.json exists in standalone (it should)
          if [ -f "$STANDALONE_DIR/package.json" ]; then
            echo "âœ… package.json found in standalone build"
          else
            echo "âš ï¸  Warning: package.json not found in standalone build"
            echo "This may cause Azure to not detect this as a Node.js app"
            echo "Checking if we need to copy it from source..."
            # Try to find package.json in artifact
            PKG_JSON=$(find artifact -name "package.json" -type f 2>/dev/null | head -1 || echo "")
            if [ -n "$PKG_JSON" ]; then
              echo "Found package.json at: $PKG_JSON"
              cp "$PKG_JSON" deploy-package/package.json
              echo "âœ… Copied package.json to deployment package"
            fi
          fi
          
          # Verify server.js exists
          if [ ! -f "deploy-package/server.js" ]; then
            echo "âŒ Error: server.js not found in standalone output"
            echo "Deployment package contents:"
            ls -la deploy-package/ | head -20
            exit 1
          fi
          
          echo "âœ… Deployment package prepared"
          echo "Contents:"
          ls -la deploy-package/ | head -20
          echo ""
          echo "Verifying server.js:"
          head -5 deploy-package/server.js || echo "Could not read server.js"
      
      - name: Verify deployment package structure
        run: |
          echo "ðŸ” Verifying deployment package structure..."
          
          # Check critical files
          MISSING_FILES=0
          
          if [ ! -f "deploy-package/server.js" ]; then
            echo "âŒ Error: server.js not found"
            MISSING_FILES=$((MISSING_FILES + 1))
          else
            echo "âœ… server.js found"
            # Check if it's executable or at least readable
            if [ ! -r "deploy-package/server.js" ]; then
              echo "âš ï¸  Warning: server.js is not readable"
            fi
          fi
          
          if [ ! -d "deploy-package/.next/static" ]; then
            echo "âš ï¸  Warning: .next/static directory not found"
          else
            echo "âœ… .next/static directory found"
          fi
          
          if [ ! -d "deploy-package/public" ]; then
            echo "âš ï¸  Warning: public directory not found (may be optional)"
          else
            echo "âœ… public directory found"
          fi
          
          # Check for node_modules (should exist in standalone)
          if [ ! -d "deploy-package/node_modules" ]; then
            echo "âš ï¸  Warning: node_modules directory not found in standalone build"
            echo "This may cause runtime errors"
          else
            echo "âœ… node_modules directory found"
          fi
          
          # Check package.json (may be needed for Node.js detection)
          if [ ! -f "deploy-package/package.json" ]; then
            echo "âš ï¸  Warning: package.json not found in deployment package"
            echo "Azure may have trouble detecting this as a Node.js app"
          else
            echo "âœ… package.json found"
          fi
          
          if [ $MISSING_FILES -gt 0 ]; then
            echo "âŒ Error: Critical files missing in deployment package"
            echo "Deployment package structure:"
            find deploy-package -type f -name "*.js" | head -10
            find deploy-package -type d | head -10
            exit 1
          fi
          
          echo "âœ… Deployment package structure verified"
          echo "Package size: $(du -sh deploy-package | awk '{print $1}')"
          echo "File count: $(find deploy-package -type f | wc -l)"
      
      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_577CA716950C4C849FCD8534DB68F666 }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_E0A871202B5249189A79EA035FBEB0E8 }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_07BBF5665D464E728201D26286D736CD }}

      - name: Configure Azure Web App for standalone mode
        run: |
          APP_NAME="SmartWatts"
          RESOURCE_GROUP=$(az webapp show --name $APP_NAME --query resourceGroup -o tsv 2>/dev/null || echo "")
          
          if [ -z "$RESOURCE_GROUP" ]; then
            RESOURCE_GROUP=$(az webapp list --query "[?name=='$APP_NAME'].resourceGroup" -o tsv 2>/dev/null | head -1 || echo "")
          fi
          
          if [ -n "$RESOURCE_GROUP" ]; then
            echo "âš™ï¸  Configuring Azure Web App for Next.js standalone mode..."
            
            # Check web app state and start if stopped (using -o tsv instead of jq)
            echo "Checking web app state..."
            STATE=$(az webapp show \
              --resource-group $RESOURCE_GROUP \
              --name $APP_NAME \
              --query properties.state \
              -o tsv 2>/dev/null || echo "Unknown")
            
            USAGE_STATE=$(az webapp show \
              --resource-group $RESOURCE_GROUP \
              --name $APP_NAME \
              --query properties.usageState \
              -o tsv 2>/dev/null || echo "Unknown")
            
            echo "Web app state: $STATE"
            echo "Usage state: $USAGE_STATE"
            
            if [ "$STATE" = "Stopped" ]; then
              echo "âš ï¸  Web app is stopped. Starting it now..."
              az webapp start \
                --resource-group $RESOURCE_GROUP \
                --name $APP_NAME \
                --output none
              echo "âœ… Web app started"
              # Wait a moment for the app to fully start
              sleep 5
            elif [ "$USAGE_STATE" = "Exceeded" ]; then
              echo "âš ï¸  Warning: Web app usage state is 'Exceeded' (quota exceeded)"
              echo "Attempting to start the app anyway..."
              az webapp start \
                --resource-group $RESOURCE_GROUP \
                --name $APP_NAME \
                --output none 2>/dev/null || echo "Could not start app (quota issue may need manual resolution)"
              echo "âš ï¸  Note: Quota issues need to be resolved in the Azure Portal"
            elif [ "$STATE" = "Running" ]; then
              echo "âœ… Web app is already running"
            else
              echo "âš ï¸  Web app state is '$STATE' - attempting to start..."
              az webapp start \
                --resource-group $RESOURCE_GROUP \
                --name $APP_NAME \
                --output none 2>/dev/null || echo "Could not start app"
            fi
            
            # Set startup command to use node server.js
            echo "Setting startup file to 'node server.js'..."
            az webapp config set \
              --resource-group $RESOURCE_GROUP \
              --name $APP_NAME \
              --startup-file "node server.js" \
              --output none
            
            # Verify startup file was set
            STARTUP_FILE=$(az webapp config show \
              --resource-group $RESOURCE_GROUP \
              --name $APP_NAME \
              --query appCommandLine \
              -o tsv 2>/dev/null || echo "")
            
            if [ "$STARTUP_FILE" = "node server.js" ]; then
              echo "âœ… Startup file verified: $STARTUP_FILE"
            else
              echo "âš ï¸  Warning: Startup file may not be set correctly. Got: '$STARTUP_FILE'"
            fi
            
            # Disable build during deployment
            az webapp config appsettings set \
              --resource-group $RESOURCE_GROUP \
              --name $APP_NAME \
              --settings \
                SCM_DO_BUILD_DURING_DEPLOYMENT=false \
                ENABLE_ORYX_BUILD=false \
                POST_BUILD_COMMAND="" \
                PRE_BUILD_COMMAND="" \
              --output none
            
            echo "âœ… Azure Web App configured for standalone mode"
          else
            echo "âš ï¸  Could not determine resource group, skipping configuration"
          fi

      - name: Check for active deployments
        id: check-deployment
        continue-on-error: true
        run: |
          APP_NAME="SmartWatts"
          
          # Try multiple methods to find the resource group
          RESOURCE_GROUP=$(az webapp show --name $APP_NAME --query resourceGroup -o tsv 2>/dev/null || echo "")
          
          # If that fails, try searching for the web app
          if [ -z "$RESOURCE_GROUP" ]; then
            echo "âš ï¸  Could not get resource group from webapp show, trying alternative method..."
            RESOURCE_GROUP=$(az webapp list --query "[?name=='$APP_NAME'].resourceGroup" -o tsv 2>/dev/null | head -1 || echo "")
          fi
          
          if [ -z "$RESOURCE_GROUP" ]; then
            echo "âš ï¸  Could not determine resource group for web app '$APP_NAME'"
            echo "Skipping active deployment check (web app may not exist yet)"
            echo "active=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "âœ… Found resource group: $RESOURCE_GROUP"
          
          echo "Checking for active deployments in resource group: $RESOURCE_GROUP"
          
          # Check for active deployments
          ACTIVE_DEPLOYMENTS=$(az webapp deployment list \
            --resource-group $RESOURCE_GROUP \
            --name $APP_NAME \
            --query "[?status=='Running' || status=='InProgress'].id" \
            -o tsv 2>/dev/null || echo "")
          
          if [ -n "$ACTIVE_DEPLOYMENTS" ]; then
            echo "âš ï¸  Active deployment(s) found, waiting for completion..."
            echo "active=true" >> $GITHUB_OUTPUT
            
            # Wait for active deployments to complete (max 10 minutes)
            MAX_WAIT=600
            ELAPSED=0
            while [ $ELAPSED -lt $MAX_WAIT ]; do
              ACTIVE=$(az webapp deployment list \
                --resource-group $RESOURCE_GROUP \
                --name $APP_NAME \
                --query "[?status=='Running' || status=='InProgress'].id" \
                -o tsv 2>/dev/null || echo "")
              
              if [ -z "$ACTIVE" ]; then
                echo "âœ… All active deployments completed"
                echo "active=false" >> $GITHUB_OUTPUT
                break
              fi
              
              echo "â³ Waiting for deployment to complete... (${ELAPSED}s elapsed)"
              sleep 10
              ELAPSED=$((ELAPSED + 10))
            done
            
            if [ $ELAPSED -ge $MAX_WAIT ]; then
              echo "âš ï¸  Warning: Timeout waiting for active deployments, proceeding anyway"
            fi
          else
            echo "âœ… No active deployments found"
            echo "active=false" >> $GITHUB_OUTPUT
          fi

      - name: 'Deploy to Azure Web App'
        id: deploy-to-webapp
        timeout-minutes: 15
        continue-on-error: true
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'SmartWatts'
          slot-name: 'Production'
          package: ./deploy-package
          
      - name: Handle deployment result
        if: steps.deploy-to-webapp.outcome == 'failure'
        continue-on-error: true
        run: |
          echo "âš ï¸  Deployment step failed, checking for conflict errors..."
          
          APP_NAME="SmartWatts"
          
          # Try multiple methods to find the resource group
          RESOURCE_GROUP=$(az webapp show --name $APP_NAME --query resourceGroup -o tsv 2>/dev/null || echo "")
          
          # If that fails, try searching for the web app
          if [ -z "$RESOURCE_GROUP" ]; then
            echo "âš ï¸  Could not get resource group from webapp show, trying alternative method..."
            RESOURCE_GROUP=$(az webapp list --query "[?name=='$APP_NAME'].resourceGroup" -o tsv 2>/dev/null | head -1 || echo "")
          fi
          
          # If we still can't find it, try to list all web apps and search
          if [ -z "$RESOURCE_GROUP" ]; then
            echo "âš ï¸  Could not determine resource group for web app '$APP_NAME'"
            echo "This might mean:"
            echo "  - The web app doesn't exist yet"
            echo "  - There's an authentication issue"
            echo "  - The web app name is incorrect"
            echo ""
            echo "Checking if this is a conflict error (409) from the deployment logs..."
            
            # Since we can't check active deployments without resource group,
            # we'll assume it's a conflict if the deployment action reported a 409
            # The azure/webapps-deploy action typically outputs "Conflict (CODE: 409)"
            echo "âš ï¸  Unable to verify conflict status without resource group"
            echo "If the error above shows 'Conflict (CODE: 409)', this is a transient conflict."
            echo "The deployment will be retried on the next workflow run."
            echo ""
            echo "To resolve:"
            echo "  1. Check if the web app exists: az webapp list --query \"[?name=='$APP_NAME']\""
            echo "  2. Check the Azure Portal for stuck deployments"
            echo "  3. Verify the web app name is correct"
            
            # Don't fail the workflow - let the user check the logs
            exit 0
          fi
          
          echo "âœ… Found resource group: $RESOURCE_GROUP"
          
          # Check if there are active deployments (which indicates a conflict)
          ACTIVE_DEPLOYMENTS=$(az webapp deployment list \
            --resource-group $RESOURCE_GROUP \
            --name $APP_NAME \
            --query "[?status=='Running' || status=='InProgress'].id" \
            -o tsv 2>/dev/null || echo "")
          
          if [ -n "$ACTIVE_DEPLOYMENTS" ]; then
            echo "âš ï¸  Deployment conflict detected (409) - another deployment is in progress"
            echo "This is a transient conflict that will resolve automatically."
            echo "The deployment will be retried on the next workflow run."
            echo "If this persists, check the Azure Portal for stuck deployments."
            echo "Active deployment IDs: $ACTIVE_DEPLOYMENTS"
            exit 0  # Don't fail the workflow for conflicts
          fi
          
          # No active deployments but deployment failed - this is a real error
          echo "âŒ Deployment failed and no active deployments found"
          echo "This appears to be a non-conflict error."
          echo ""
          
          # Check if this is a 403 "Site Disabled" error (using -o tsv instead of jq)
          echo "Checking web app state..."
          STATE=$(az webapp show \
            --resource-group $RESOURCE_GROUP \
            --name $APP_NAME \
            --query properties.state \
            -o tsv 2>/dev/null || echo "Unknown")
          
          USAGE_STATE=$(az webapp show \
            --resource-group $RESOURCE_GROUP \
            --name $APP_NAME \
            --query properties.usageState \
            -o tsv 2>/dev/null || echo "Unknown")
          
          echo "Web app state: $STATE"
          echo "Usage state: $USAGE_STATE"
          
          if [ "$STATE" = "Stopped" ] || [ "$USAGE_STATE" = "Exceeded" ]; then
            echo ""
            echo "âš ï¸  Error: Site Disabled (CODE: 403) - Web app is stopped or quota exceeded"
            echo "Attempting to start the web app..."
            az webapp start \
              --resource-group $RESOURCE_GROUP \
              --name $APP_NAME \
              --output none 2>/dev/null && echo "âœ… Web app started" || echo "âŒ Could not start web app"
            echo ""
            echo "If the app was stopped, please retry the deployment."
            echo "If quota is exceeded, please resolve the quota issue in the Azure Portal."
            exit 1
          fi
          
          echo ""
          echo "Retrieving deployment logs..."
          
          # Get the latest deployment log
          DEPLOYMENT_ID=$(az webapp deployment list \
            --resource-group $RESOURCE_GROUP \
            --name $APP_NAME \
            --query "[0].id" -o tsv 2>/dev/null || echo "")
          
          if [ -n "$DEPLOYMENT_ID" ]; then
            echo "Latest deployment ID: $DEPLOYMENT_ID"
            echo "Retrieving deployment log..."
            az webapp deployment log show \
              --resource-group $RESOURCE_GROUP \
              --name $APP_NAME \
              --deployment-id "$DEPLOYMENT_ID" 2>/dev/null | tail -50 || echo "Could not retrieve deployment log"
          fi
          
          echo ""
          echo "Checking web app configuration..."
          az webapp config show \
            --resource-group $RESOURCE_GROUP \
            --name $APP_NAME \
            --query "{linuxFxVersion:linuxFxVersion,appCommandLine:appCommandLine}" -o table 2>/dev/null || echo "Could not retrieve web app config"
          
          echo ""
          echo "Checking startup file setting..."
          STARTUP_FILE=$(az webapp config show \
            --resource-group $RESOURCE_GROUP \
            --name $APP_NAME \
            --query "appCommandLine" -o tsv 2>/dev/null || echo "")
          echo "Startup file: ${STARTUP_FILE:-'Not set'}"
          
          echo ""
          echo "Common causes:"
          echo "  - Invalid package structure"
          echo "  - Missing server.js or incorrect startup command"
          echo "  - Missing dependencies in standalone build"
          echo "  - Build errors"
          echo "  - Permission issues"
          echo "  - Web app configuration issues"
          echo ""
          echo "Please check the deployment logs above for specific error messages"
          exit 1
          